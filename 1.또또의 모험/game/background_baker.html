<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Mabu Background Baker (All Stages)</title>
    <style>
        body {
            background: #1a1a1a;
            color: #eee;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .sidebar {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 720px;
            overflow-y: auto;
        }

        .sidebar button {
            padding: 10px;
            text-align: left;
            background: #333;
            border: 1px solid #444;
            color: #ccc;
            cursor: pointer;
            border-radius: 4px;
            transition: 0.2s;
        }

        .sidebar button:hover {
            background: #444;
            color: #fff;
        }

        .sidebar button.active {
            background: #0288d1;
            color: white;
            border-color: #039be5;
        }

        .main-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        canvas {
            border: 2px solid #555;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            background: #000;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .btn-action {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            min-width: 150px;
        }

        .btn-gen {
            background: #00897b;
            color: white;
        }

        .btn-gen:hover {
            background: #009688;
        }

        .btn-save {
            background: #d81b60;
            color: white;
        }

        .btn-save:hover {
            background: #e91e63;
        }

        .info {
            margin-top: 10px;
            color: #aaa;
            font-size: 14px;
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>ÔøΩ Mabu Background Studio</h1>
    <p class="info">Í∞Å Ïä§ÌÖåÏù¥ÏßÄÎ•º ÏÑ†ÌÉùÌïòÍ≥† ÎîîÏûêÏù∏ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî. 'Regenerate'Î°ú Íµ¨Î¶Ñ Î™®ÏñëÏùÑ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>

    <div class="layout">
        <div class="sidebar" id="stageList">
            <!-- Buttons generated via JS -->
        </div>

        <div class="main-view">
            <canvas id="gameCanvas" width="1280" height="720"></canvas>
            <div class="toolbar">
                <button class="btn-action btn-gen" onclick="renderCurrent()">ÔøΩ Regenerate</button>
                <button class="btn-action btn-save" onclick="downloadBG()">üíæ Save PNG</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const CONFIG = { SCREEN_WIDTH: 1280, SCREEN_HEIGHT: 720 };
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let currentStage = 1;

        // --- STAGE DEFINITIONS ---
        // 1, 4, 7 -> Day (Cycle)
        // 2, 5, 8 -> Night (Cycle)
        // 3, 6, 9 -> Sunset (Cycle)
        // 10 -> Boss Special (Night/Storm)

        const STAGE_THEMES = {
            1: { type: 'DAY', name: 'Stage 1: Peaceful Forest' },
            2: { type: 'NIGHT', name: 'Stage 2: Night Watch' },
            3: { type: 'SUNSET', name: 'Stage 3: Crimson Twilight' },
            4: { type: 'DAY', name: 'Stage 4: Windy Valley', wind: true },
            5: { type: 'NIGHT', name: 'Stage 5: Misty Woods', fog: true },
            6: { type: 'SUNSET', name: 'Stage 6: Burning Horizon' },
            7: { type: 'DAY', name: 'Stage 7: Junkyard' },
            8: { type: 'NIGHT', name: 'Stage 8: Toxic Lab' },
            9: { type: 'SUNSET', name: 'Stage 9: Sky Fortress' },
            10: { type: 'BOSS', name: 'Stage 10: Emperor\'s Throne' }
        };

        const PALETTES = {
            'DAY': {
                skyTop: '#4fc3f7', skyBot: '#b3e5fc',
                cloudLight: '#ffffff', cloudMid: '#e1f5fe', cloudShadow: '#b3e5fc',
                bgTree: '#2e7d32', fgTreeTrunk: '#5d4037', fgTreeLeaf: '#66bb6a',
                ground: '#388e3c', detail: '#4caf50', accent: '#a5d6a7',
                crescent: false, stars: false, sun: true
            },
            'NIGHT': {
                skyTop: '#0d1117', skyBot: '#161b22',
                cloudLight: '#9fa8da', cloudMid: '#5c6bc0', cloudShadow: '#3949ab',
                bgTree: '#0d1930', fgTreeTrunk: '#0d1930', fgTreeLeaf: '#1a237e',
                ground: '#050a14', detail: '#1f2937', accent: '#304ffe',
                crescent: true, stars: true, sun: false
            },
            'SUNSET': {
                skyTop: '#280c40', skyBot: '#d81b60', // Purple to Pink/Red
                cloudLight: '#ffcc80', cloudMid: '#ef9a9a', cloudShadow: '#c62828',
                bgTree: '#4a148c', fgTreeTrunk: '#3e2723', fgTreeLeaf: '#880e4f',
                ground: '#4a0072', detail: '#7b1fa2', accent: '#ffb74d',
                crescent: false, stars: true, sun: true // Low sun
            },
            'BOSS': { // Dark Stormy
                skyTop: '#000000', skyBot: '#263238',
                cloudLight: '#546e7a', cloudMid: '#37474f', cloudShadow: '#212121',
                bgTree: '#000000', fgTreeTrunk: '#212121', fgTreeLeaf: '#263238',
                ground: '#102027', detail: '#37474f', accent: '#cfd8dc',
                crescent: false, stars: false, lightning: true
            }
        };

        // --- DRAWING LOGIC ---

        const drawRect = (ctx, x, y, w, h, color) => {
            ctx.fillStyle = color;
            ctx.fillRect(Math.floor(x), Math.floor(y), w, h);
        };

        function drawPixelCloudCluster(ctx, x, y, size, colors) {
            const p = 4;
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(size, size);

            const clusters = [
                { x: 0, y: 0, r: 40 },
                { x: 25, y: -10, r: 35 },
                { x: -25, y: -5, r: 30 },
                { x: 50, y: 5, r: 25 },
                { x: -45, y: 10, r: 25 },
                { x: 0, y: -20, r: 25 } // Extra top fluff
            ];

            // Randomize slightly for "Regenerate"
            if (Math.random() > 0.5) clusters.push({ x: (Math.random() - 0.5) * 60, y: -20, r: 20 });

            const layers = [
                { color: colors.shadow, offY: 15, scale: 1.0 },
                { color: colors.mid, offY: 5, scale: 0.92 },
                { color: colors.light, offY: -5, scale: 0.85 }
            ];

            layers.forEach(layer => {
                ctx.fillStyle = layer.color;
                clusters.forEach(c => {
                    let cr = c.r * layer.scale;
                    for (let dy = -cr; dy <= cr; dy += p) {
                        for (let dx = -cr; dx <= cr; dx += p) {
                            if (dx * dx + dy * dy <= cr * cr) {
                                if (dx * dx + dy * dy > (cr - p) * (cr - p) && Math.random() > 0.6) continue;
                                ctx.fillRect(c.x + dx, c.y + layer.offY + dy, p, p);
                            }
                        }
                    }
                });
            });
            ctx.restore();
        }

        // --- PRECISE PIXEL ART ENGINE ---

        // Helper to draw a pixel-perfect cloud shape
        // x, y: position
        // w, h: approximate size
        // type: 'fluffy' or 'flat'
        function drawPixelCloudShape(ctx, x, y, w, h, color) {
            const step = 4; // Pixel size
            ctx.fillStyle = color;

            // Draw a blocky ellipse
            const cx = x + w / 2;
            const cy = y + h / 2;
            const rx = w / 2;
            const ry = h / 2;

            for (let py = y; py < y + h; py += step) {
                for (let px = x; px < x + w; px += step) {
                    // Ellipse equation check with noise for pixel art rough edges
                    const dx = px - cx;
                    const dy = py - cy;
                    // Normalized distance
                    const dist = (dx * dx) / (rx * rx) + (dy * dy) / (ry * ry);

                    if (dist <= 0.8) { // Inner core
                        ctx.fillRect(px, py, step, step);
                    } else if (dist <= 1.0) { // Edge dithering
                        // Only draw some pixels to create "staircase" effect
                        if (((px + py) / step) % 2 === 0) ctx.fillRect(px, py, step, step);
                    }
                }
            }
        }

        // The "Han-sooni Masterpiece" Renderer for Stage 2
        function drawMasterpieceStage2(ctx) {
            // Palette based on Reference
            const C = {
                skyTop: '#1e1e30',   // Dark midnight blue
                skyBot: '#2d2d44',   // Slightly lighter horizon
                stars: '#ffffff',
                moon: '#fdfd96',     // Pale yellow
                cloudBase: '#2a2a40',// Darkest shadow (blends with sky)
                cloudMid: '#3e3e5e', // Mid-tone blue-grey
                cloudHigh: '#5a5a80',// Light blue-grey
                cloudTop: '#b0b0d0'  // Highlight (Rim light)
            };

            // 1. Sky Gradient
            const h = CONFIG.SCREEN_HEIGHT;
            // Manual banding for pixel art feel
            ctx.fillStyle = C.skyTop; ctx.fillRect(0, 0, CONFIG.SCREEN_WIDTH, h * 0.4);
            ctx.fillStyle = C.skyBot; ctx.fillRect(0, h * 0.4, CONFIG.SCREEN_WIDTH, h * 0.6);

            // 2. Stars (Sparse, twinkling)
            ctx.fillStyle = C.stars;
            for (let i = 0; i < 60; i++) {
                const x = Math.random() * CONFIG.SCREEN_WIDTH;
                const y = Math.random() * h * 0.5;
                if (Math.random() > 0.9) ctx.fillRect(x, y, 4, 4); // Big star
                else ctx.fillRect(x, y, 2, 2); // Small star
            }

            // 3. Moon (Sharp Crescent)
            ctx.save();
            ctx.translate(950, 120);
            const r = 35;
            ctx.fillStyle = C.moon;
            // Main circle
            for (let y = -r; y <= r; y += 2) {
                for (let x = -r; x <= r; x += 2) {
                    if (x * x + y * y <= r * r) {
                        // Cutout circle for crescent
                        // Shifted right-up
                        const cutX = x - 12;
                        const cutY = y - 8;
                        if (cutX * cutX + cutY * cutY > (r - 4) * (r - 4)) {
                            ctx.fillRect(x, y, 2, 2);
                        }
                    }
                }
            }
            ctx.restore();

            // 4. Clouds - Hand-Composed Layers
            // We build the cloudscape from back to front, manual placement to match reference composition

            const shapes = [
                // Layer 1: Dark Base (Shadows) covering bottom
                { x: -100, y: 400, w: 600, h: 400, c: C.cloudBase },
                { x: 400, y: 450, w: 500, h: 350, c: C.cloudBase },
                { x: 800, y: 500, w: 600, h: 300, c: C.cloudBase },

                // Layer 2: Mid Tones
                { x: -50, y: 420, w: 500, h: 300, c: C.cloudMid },
                { x: 350, y: 480, w: 400, h: 250, c: C.cloudMid },
                { x: 900, y: 520, w: 500, h: 250, c: C.cloudMid },

                // Layer 3: High Tones
                { x: 0, y: 430, w: 400, h: 200, c: C.cloudHigh },
                { x: 300, y: 480, w: 300, h: 150, c: C.cloudHigh },
                { x: 1000, y: 530, w: 350, h: 180, c: C.cloudHigh },

                // Layer 4: Top Highlights (Rim)
                { x: 50, y: 430, w: 250, h: 50, c: C.cloudTop },
                { x: 300, y: 480, w: 200, h: 40, c: C.cloudTop },
                { x: 1050, y: 530, w: 250, h: 40, c: C.cloudTop },
            ];

            // Use pixel drawer for organic edges
            shapes.forEach(s => drawPixelCloudShape(ctx, s.x, s.y, s.w, s.h, s.c));
        }

        function renderStage(ctx, stageNum) {
            // Special handling for Stage 2 (Masterpiece Request)
            if (stageNum === 2) {
                drawMasterpieceStage2(ctx);
                return;
            }

            // ... Existing logic for other stages ...
            const def = STAGE_THEMES[stageNum];
            const theme = PALETTES[def.type] || PALETTES['DAY'];

            // 1. Sky Gradient
            const h = CONFIG.SCREEN_HEIGHT;
            const stops = 16;
            for (let i = 0; i < stops; i++) {
                const r = i / stops;
                // Simple linear lerp only for demonstration, pixel rects
                ctx.fillStyle = i < stops / 2 ? theme.skyTop : theme.skyBot;
                // Let's improve blending:
                if (i >= 5 && i <= 10) {
                    // Mid-blend hack
                    ctx.fillStyle = (i % 2 === 0) ? theme.skyTop : theme.skyBot;
                }
                ctx.fillRect(0, i * (h / stops), CONFIG.SCREEN_WIDTH, (h / stops) + 1);
            }

            // 2. Stars
            if (theme.stars) {
                ctx.fillStyle = '#FFF';
                for (let i = 0; i < 80; i++) {
                    const x = Math.random() * CONFIG.SCREEN_WIDTH;
                    const y = Math.random() * CONFIG.SCREEN_HEIGHT * 0.6;
                    ctx.fillRect(Math.floor(x), Math.floor(y), Math.random() > 0.8 ? 3 : 2, Math.random() > 0.8 ? 3 : 2);
                }
            }

            // 3. Celestial Bodies
            if (theme.crescent) {
                ctx.save();
                ctx.translate(1000, 150);
                ctx.fillStyle = '#fff176';
                for (let y = -30; y <= 30; y += 2) {
                    for (let x = -30; x <= 30; x += 2) {
                        if (x * x + y * y <= 30 * 30) {
                            if ((x - 10) * (x - 10) + (y - 5) * (y - 5) > 25 * 25) ctx.fillRect(x, y, 2, 2);
                        }
                    }
                }
                ctx.restore();
            }
            if (theme.sun) {
                ctx.save();
                ctx.translate(200, def.type === 'SUNSET' ? 400 : 100);
                ctx.fillStyle = def.type === 'SUNSET' ? '#ffcc80' : 'rgba(255,255,255,0.4)';
                // Big pixel sun
                const r = 40;
                for (let y = -r; y <= r; y += 2) {
                    for (let x = -r; x <= r; x += 2) {
                        if (x * x + y * y <= r * r) ctx.fillRect(x, y, 2, 2);
                    }
                }
                ctx.restore();
            }

            // 4. Clouds (The Star of the Show)
            const cloudColors = { light: theme.cloudLight, mid: theme.cloudMid, shadow: theme.cloudShadow };
            const positions = [
                { x: 100, y: 500, s: 1.5 }, { x: 600, y: 550, s: 1.2 }, { x: 1100, y: 480, s: 1.5 },
                { x: -50, y: 650, s: 2.5 }, { x: 400, y: 700, s: 2.0 }, { x: 900, y: 680, s: 2.8 }, { x: 1300, y: 650, s: 2.2 }
            ];

            positions.forEach(pos => {
                drawPixelCloudCluster(ctx, pos.x, pos.y, pos.s, cloudColors);
            });

            // 5. Far Trees (Silhouette)
            ctx.fillStyle = theme.bgTree;
            const farCount = 30;
            for (let i = 0; i < farCount; i++) {
                const x = (CONFIG.SCREEN_WIDTH / farCount) * i;
                const h = 50 + Math.random() * 80;
                ctx.fillRect(x, CONFIG.SCREEN_HEIGHT - h, 50, h);
                // Triangle top
                ctx.beginPath();
                ctx.moveTo(x, CONFIG.SCREEN_HEIGHT - h);
                ctx.lineTo(x + 25, CONFIG.SCREEN_HEIGHT - h - 30);
                ctx.lineTo(x + 50, CONFIG.SCREEN_HEIGHT - h);
                ctx.fill();
            }

            // 6. Near Trees (Detailed)
            // Just a few to frame the shot
            const drawTree = (x, scale) => {
                ctx.fillStyle = theme.fgTreeTrunk;
                drawRect(ctx, x, CONFIG.SCREEN_HEIGHT - 100 * scale, 20 * scale, 100 * scale);
                ctx.fillStyle = theme.fgTreeLeaf;
                drawRect(ctx, x - 30 * scale, CONFIG.SCREEN_HEIGHT - 200 * scale, 80 * scale, 120 * scale);
            };
            drawTree(100, 1.2);
            drawTree(1100, 1.5);

            // 7. Ground
            ctx.fillStyle = theme.ground;
            ctx.fillRect(0, CONFIG.SCREEN_HEIGHT - 50, CONFIG.SCREEN_WIDTH, 50);

            // 8. Overlays
            if (def.type === 'BOSS') {
                // Rain/Storm
                ctx.fillStyle = 'rgba(200, 230, 255, 0.1)';
                for (let i = 0; i < 100; i++) {
                    const rx = Math.random() * CONFIG.SCREEN_WIDTH;
                    const ry = Math.random() * CONFIG.SCREEN_HEIGHT;
                    drawRect(ctx, rx, ry, 2, 20);
                }
            }
        }

        // 1. General Buzz (Wasp)
        function drawGeneralBuzz(ctx) {
            const scale = 3;
            ctx.scale(scale, scale);

            // Body
            ctx.fillStyle = '#fdd835'; // Yellow
            ctx.beginPath(); ctx.ellipse(0, 0, 40, 50, 0, 0, Math.PI * 2); ctx.fill();
            // Stripes
            ctx.fillStyle = '#212121';
            ctx.fillRect(-35, -10, 70, 10);
            ctx.fillRect(-30, 15, 60, 10);

            // Head + Cap
            ctx.fillStyle = '#fdd835';
            ctx.beginPath(); ctx.arc(0, -50, 25, 0, Math.PI * 2); ctx.fill();
            // Cap
            ctx.fillStyle = '#2e7d32'; // Green Cap
            ctx.fillRect(-30, -75, 60, 20);
            ctx.fillStyle = '#1b5e20';
            ctx.fillRect(-35, -55, 70, 5); // Brim

            // Stinger
            ctx.fillStyle = '#212121';
            ctx.beginPath(); ctx.moveTo(-10, 45); ctx.lineTo(10, 45); ctx.lineTo(0, 80); ctx.fill();

            // Wings
            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.beginPath(); ctx.ellipse(-40, -20, 30, 60, -0.5, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(40, -20, 30, 60, 0.5, 0, Math.PI * 2); ctx.fill();
        }

        // 2. Queen Arachne (Spider)
        function drawQueenArachne(ctx) {
            const scale = 3;
            ctx.scale(scale, scale);

            // Legs
            ctx.strokeStyle = '#212121';
            ctx.lineWidth = 4;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath(); ctx.moveTo(0, 0);
                ctx.quadraticCurveTo(-60 - i * 10, -50 + i * 20, -80, 50); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, 0);
                ctx.quadraticCurveTo(60 + i * 10, -50 + i * 20, 80, 50); ctx.stroke();
            }

            // Abdomen
            ctx.fillStyle = '#311b92'; // Dark Purple
            ctx.beginPath(); ctx.ellipse(0, 10, 45, 55, 0, 0, Math.PI * 2); ctx.fill();
            // Pattern
            ctx.fillStyle = '#ff4081'; // Neon Pink
            ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(-10, 0); ctx.lineTo(0, 20); ctx.lineTo(10, 0); ctx.fill();

            // Crown
            ctx.fillStyle = '#ffd700';
            ctx.beginPath(); ctx.moveTo(-15, -45); ctx.lineTo(-5, -35); ctx.lineTo(5, -35); ctx.lineTo(15, -45); ctx.lineTo(0, -35); ctx.fill();
        }

        // 3. Metal Orochi (Snake)
        function drawMetalOrochi(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Coils
            ctx.fillStyle = '#9e9e9e'; // Silver
            ctx.beginPath(); ctx.ellipse(-30, 40, 50, 20, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(20, 20, 40, 20, 0, 0, Math.PI * 2); ctx.fill();

            // Head (Long)
            ctx.fillStyle = '#bdbdbd';
            ctx.beginPath(); ctx.moveTo(20, 0); ctx.lineTo(50, -40); ctx.lineTo(70, -30); ctx.lineTo(40, 30); ctx.fill();

            // Eye
            ctx.fillStyle = '#00e676'; // Green LED
            ctx.beginPath(); ctx.arc(45, -20, 5, 0, Math.PI * 2); ctx.fill();

            // Laser Cannon Mouth
            ctx.fillStyle = '#ff1744';
            ctx.fillRect(60, -25, 10, 20);
        }

        // 4. Storm Falcon (Bird)
        function drawStormFalcon(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Wings Spread
            ctx.fillStyle = '#0277bd'; // Blue
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-80, -40); ctx.lineTo(-60, 20); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(80, -40); ctx.lineTo(60, 20); ctx.fill();

            // Body
            ctx.fillStyle = '#eceff1';
            ctx.beginPath(); ctx.ellipse(0, 0, 20, 40, 0, 0, Math.PI * 2); ctx.fill();

            // Head + Goggles
            ctx.fillStyle = '#eceff1';
            ctx.beginPath(); ctx.arc(0, -30, 15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#37474f'; // Goggles
            ctx.fillRect(-15, -35, 30, 10);
            ctx.fillStyle = '#29b6f6'; // Glass
            ctx.fillRect(-12, -33, 10, 6); ctx.fillRect(2, -33, 10, 6);
        }

        // 5. Phantom Moth
        function drawPhantomMoth(ctx) {
            const scale = 3.5; ctx.scale(scale, scale);

            // Wings (Pastel)
            ctx.fillStyle = '#b39ddb'; // Lavender
            ctx.beginPath(); ctx.ellipse(-30, -10, 30, 50, -0.5, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.ellipse(30, -10, 30, 50, 0.5, 0, Math.PI * 2); ctx.fill();

            // Eye Pattern
            ctx.fillStyle = '#80deea';
            ctx.beginPath(); ctx.arc(-30, -10, 8, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(30, -10, 8, 0, Math.PI * 2); ctx.fill();

            // Body
            ctx.fillStyle = '#fff9c4'; // Fluffy
            ctx.beginPath(); ctx.ellipse(0, 0, 10, 30, 0, 0, Math.PI * 2); ctx.fill();
        }

        // 6. Flame Salamander
        function drawFlameSalamander(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Body
            ctx.fillStyle = '#d84315'; // Red Orange
            ctx.beginPath(); ctx.ellipse(0, 0, 60, 25, 0, 0, Math.PI * 2); ctx.fill();

            // Flames on back
            ctx.fillStyle = '#ffeb3b';
            ctx.beginPath(); ctx.moveTo(-40, -10); ctx.lineTo(-30, -40); ctx.lineTo(-20, -10); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, -15); ctx.lineTo(10, -50); ctx.lineTo(20, -15); ctx.fill();

            // Head
            ctx.fillStyle = '#d84315';
            ctx.beginPath(); ctx.arc(-50, 0, 20, 0, Math.PI * 2); ctx.fill();
        }

        // 7. Junk Amalgam
        function drawJunkAmalgam(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Blob of junk
            ctx.fillStyle = '#5d4037'; // Rust
            ctx.fillRect(-40, -40, 80, 80);

            // TV
            ctx.fillStyle = '#424242';
            ctx.fillRect(-30, -50, 40, 30);
            ctx.fillStyle = '#81d4fa'; // Screen
            ctx.fillRect(-25, -45, 30, 20);

            // Pipe
            ctx.fillStyle = '#757575';
            ctx.fillRect(20, -20, 40, 10);

            // Core
            ctx.fillStyle = '#f44336';
            ctx.beginPath(); ctx.arc(0, 10, 10, 0, Math.PI * 2); ctx.fill();
        }

        // 8. Toxic Chimera
        function drawToxicChimera(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Body
            ctx.fillStyle = '#7b1fa2'; // Purple
            ctx.beginPath(); ctx.arc(0, 0, 40, 0, Math.PI * 2); ctx.fill();

            // Pustules
            ctx.fillStyle = '#76ff03'; // Toxic Green
            ctx.beginPath(); ctx.arc(-20, -10, 8, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(15, 15, 12, 0, Math.PI * 2); ctx.fill();

            // Gas Mask
            ctx.fillStyle = '#455a64';
            ctx.beginPath(); ctx.arc(0, -10, 15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(-5, -10, 5, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(5, -10, 5, 0, Math.PI * 2); ctx.fill();
        }

        // 9. Sky Fortress Core
        function drawSkyFortressCore(ctx) {
            const scale = 3.5; ctx.scale(scale, scale);

            // Cylinder
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(-40, -60, 80, 120);
            // Rings
            ctx.fillStyle = '#78909c';
            ctx.fillRect(-45, -40, 90, 10);
            ctx.fillRect(-45, 0, 90, 10);
            ctx.fillRect(-45, 40, 90, 10);

            // Core
            ctx.fillStyle = '#00b0ff'; // Energy Blue
            ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI * 2); ctx.fill();

            // Wires
            ctx.strokeStyle = '#fdd835';
            ctx.beginPath(); ctx.moveTo(0, 20); ctx.lineTo(0, 60); ctx.stroke();
        }

        // 10. Emperor V
        function drawEmperorV(ctx) {
            const scale = 3; ctx.scale(scale, scale);

            // Cape
            ctx.fillStyle = '#b71c1c'; // Red
            ctx.beginPath(); ctx.moveTo(0, -60); ctx.lineTo(-40, 60); ctx.lineTo(40, 60); ctx.fill();

            // Armor
            ctx.fillStyle = '#ffab00'; // Gold
            ctx.fillRect(-20, -40, 40, 60); // Body

            // Shoulders
            ctx.fillStyle = '#ffd740';
            ctx.beginPath(); ctx.arc(-25, -35, 15, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(25, -35, 15, 0, Math.PI * 2); ctx.fill();

            // Head (Beetle Helmet)
            ctx.fillStyle = '#ff6f00';
            ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(-15, -70); ctx.lineTo(15, -70); ctx.fill();

            // Sword
            ctx.fillStyle = '#e0e0e0';
            ctx.fillRect(35, -20, 10, 80);
            ctx.fillStyle = '#ffd740';
            ctx.fillRect(30, -20, 20, 5); // Guard
        }

        // --- UI Logic ---
        function renderCurrent() {
            renderStage(ctx, currentStage);
            drawBoss(ctx, currentStage);

            // Highlight button
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${currentStage}`).classList.add('active');
        }

        function init() {
            const list = document.getElementById('stageList');
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement('button');
                const theme = STAGE_THEMES[i] || { name: `Stage ${i}` };
                // Get Boss Name
                const bossNames = {
                    1: 'General Buzz', 2: 'Queen Arachne', 3: 'Metal Orochi', 4: 'Storm Falcon',
                    5: 'Phantom Moth', 6: 'Flame Salamander', 7: 'Junk Amalgam',
                    8: 'Toxic Chimera', 9: 'Fortress Core', 10: 'Emperor V'
                };

                btn.id = `btn-${i}`;
                btn.innerHTML = `<strong>${theme.name}</strong><br><span style="font-size:12px; color:#aaa">Vs ${bossNames[i]}</span>`;
                btn.onclick = () => {
                    currentStage = i;
                    renderCurrent();
                };
                list.appendChild(btn);
            }
            renderCurrent();
        }

        function downloadBG() {
            const link = document.createElement('a');
            link.download = `bg_boss_stage_${currentStage}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        init();

    </script>
</body>

</html>